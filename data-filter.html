<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-label/iron-label.html">
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-dropdown-input/paper-dropdown-input.html">
<link rel="import" href="../paper-tags/paper-tags-dropdown.html">
<link rel="import" href="../paper-tags/paper-tags-input.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../paper-range-slider/paper-range-slider.html">
<link rel="import" href="../paper-styles/paper-styles.html">

<script src="../lodash/lodash.js"></script>

<!-- <link rel="import" href="../iron-list/iron-list.html"> -->
<!-- <link rel="import" href="../iron-dropdown/iron-dropdown.html"> -->


<dom-module id="data-filter">
    <template>

        <style>
            :host {
                display: inline-block;
                width: 100%;
            }

            table.gridtable {
                width: 100%;
                color: #333333;
            }

            table.gridtable th {
                text-align: center;
                padding: 2px;
            }

            table.gridtable td {
                padding: 2px;
            }

            paper-tags-dropdown {
                width: 100%;
            }

            .flex-horizontal {
                @apply --layout-horizontal;
            }

            .flexchild {
                @apply --layout-flex;
                padding-right: 10px;
            }

            .flex2child {
                @apply --layout-flex-4;
                border-left: 1px solid rgba(34,36,38,.15);
            }

            .flex-vertical {
                @apply --layout-vertical;
                /* height: 220px; */
            }

            .flexchild-vertical {
                @apply --layout-flex;
            }

            .table-headers {
                font-weight: bold;
            }

            .category-headers {
                color: var(--paper-input-container-input-color, var(--primary-text-color));
                @apply --paper-font-subhead;
            }

            #apply-button {
                margin-top: 8px;
            }

            /* table > thead {
            background: 
        } */

            /* .container {
            width: 100%;
            padding: 5px;
        } */
        </style>
        <div class="container flex-horizontal">
            <div class="flexchild">
                <div class="flex-vertical" id="filterContainer">
                    <paper-button id="reset-button" on-click="resetFilters" raised>Reset</paper-button>
                    <paper-button id="apply-button" on-click="applyFilters" raised>Apply</paper-button>
                    <form is="iron-form" id="form">
                        <template is="dom-repeat" items="{{_attributes}}">
                            <template is="dom-if" if="[[_settingType(item.type, 'boolean')]]">
                                <div class="flexchild-vertical">
                                    <iron-label class="category-headers">
                                        {{item.name}}
                                    </iron-label>
                                    <paper-toggle-button name="{{item.name}}" on-checked-changed="addFilter"></paper-toggle-button>
                                    <iron-label for="{{item.id}}">{{input.label}}</iron-label>
                                </div>
                            </template>
                            <template is="dom-if" if="[[_settingType(item.type, 'category')]]">
                                <div class="flexchild-vertical">
                                    <iron-label class="category-headers">
                                        {{item.name}}
                                    <paper-tags-dropdown type="{{item.type}}" items="{{item.values}}" vertical-offset="60" horizontal-offset="-150">
                                    </paper-tags-dropdown>
                                    </iron-label>

                                    <!-- <paper-dropdown-input on-value-changed="addFilter" name="{{item.name}}" label="{{item.name}}" items="{{item.values}}" placeholder="Any"></opaper-dropdown-input> -->
                                </div>
                            </template>
                            <template is="dom-if" if="[[_settingType(item.type, 'number')]]">
                                <div class="flexchild-vertical">
                                    <!-- <paper-input on-change="addFilter" name="{{item.name}}" type="number" label="{{item.name}}"></paper-input> -->
<!--                                     <paper-tags-input type="{{item.type}}" label="{{item.name}}">
                                    </paper-tags-input> -->
                                    <iron-label class="category-headers">
                                        {{item.name}}
                                    </iron-label>
                                    <paper-range-slider></paper-range-slider>

                                </div>
                            </template>
                        </template>
                    </form>
                </div>
            </div>

            <array-selector id="selector" items="{{tableData}}" selected="{{selectedItems}}" multi toggle></array-selector>

            <div class="flex2child">
                <table class="gridtable">
                    <thead>
                        <tr>
                            <td>
                                <input type="checkbox" indeterminate="[[_isIndeterminate(selectedItems.*)]]" on-click="_selectAll">
                            </td>
                            <template is="dom-repeat" items="[[showColumns]]" as="column">
                                <td class="table-headers" id="table-header-{{column}}" on-click="sortColumn">[[column]]</td>
                            </template>
                        </tr>
                    </thead>
                    <tbody>
                        <template id="dataTable" is="dom-repeat" items="[[tableData]]" as="row" initial-count="30">
                            <tr on-click="toggleSelection">
                                <td>
                                    <input class="row-check" type="checkbox">
                                </td>
                                <template is="dom-repeat" items="[[showColumns]]" as="column">
                                    <td>[[ _getItem(row, column) ]]</td>
                                </template>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </template>

    <script>
        Polymer({
            is: 'data-filter',
            properties: {
                filters: {
                    type: Object,
                    notify: true,
                    value: {},
                },

                data: {
                    type: Array,
                    notify: true,
                    observer: "_dataChanged"
                },

                tableData: {
                    type: Array,
                    notify: true
                },

                showColumns: {
                    type: Array,
                    notify: true,
                    value: []
                },

                showFilterBar: {
                    type: Boolean,
                    value: true
                },

                _attributes: {
                    type: Array,
                    value: [],
                    notify: true
                },

                selectedItems: {
                    type: Array,
                    notify: true
                }
            },

            listeners: {
                "tag-added": "addFilter",
                "tag-removed": "removeFilter",
            },

            sortColumn: function(e) {
                var self = this;
                var category = e.target.id.split('-')[2];

                this.set("tableData", _.sortBy(this.tableData, [category]));
                this.$.dataTable.render();
            },

            _settingType: function (type, expected) {
                if (type == expected) {
                    return true;
                }

                return false;
            },

            _getItem: function (row, column) {
                return row[column];
            },

            _isIndeterminate: function () {
                if (this.selectedItems && this.selectedItems.length > 0 && this.selectedItems.length != this.tableData.length) {
                    return true;
                }
                return false;
            },

            toggleSelection: function (e) {
                var item = this.$.dataTable.itemForElement(e.target);
                this.$.selector.select(item);
                e.currentTarget.querySelector("input").checked = this.$.selector.isSelected(item);
            },

            addFilter: function(e) {
                var category = e.target.label;

                if (e.type === "tag-added") {
                    if (e.target.type === "number") {
                        if (parseInt(e.detail)) {
                            this.filters[category].push(parseInt(e.detail));
                            this.filters["numFilters"]++;
                        }
                    } else {
                        this.filters[category].push(e.detail);
                        this.filters["numFilters"]++;
                    }
                }
            },

            removeFilter: function(e) {
                var category = e.target.label;

                if (e.type === "tag-removed") {
                    this.filters[category].splice(this.filters[category].indexOf(e.detail), 1);
                    this.filters["numFilters"]--;
                }
            },

            applyFilters: function () {
                var self = this;
                var filterString = [];

                for(var key in this.filters) {
                    if (key !== "numFilters") {
                        var categoryFilters = []
                        this.filters[key].forEach(function(val, index) {
                            if (val !== "Any") {
                                if (typeof (val) === "string") {
                                    categoryFilters.push("item." + key + " == '" + val + "'");
                                } else {
                                    categoryFilters.push("item." + key + " == " + val);
                                }
                            }
                        })
                        if (categoryFilters.length !== 0) {
                            filterString.push(categoryFilters);    
                        }
                    }
                }

                if (this.filters["numFilters"] === 0) {
                    this.set("tableData", this.data);
                    return;
                }

                filterString.forEach(function(val, index) {
                    filterString[index] = "(" + val.join(" || ") + ")";
                });

                var fString = filterString.join(" && ");
                this.set("tableData", this.data.filter(item => eval(fString)));
            },

            resetFilters: function(e) {
                for (var key in this.filters) {
                    this.filters[key] = [];
                }
                this.querySelectorAll("paper-tags-input").forEach(function(elem) {
                    elem.removeAll();
                });
                this.filters["numFilters"] = 0;
                this.set("tableData", this.data);
            },

            _selectAll: function (e) {
                var self = this;

                if (e.target.checked) {
                    this.tableData.forEach(function (item) {
                        if (!self.$.selector.isSelected(item)) { self.$.selector.select(item); }
                    });

                    var elems = this.querySelectorAll(".row-check");
                    elems.forEach(function (elem) { elem.checked = true; });
                }
                else {
                    self.$.selector.clearSelection();
                    var elems = this.querySelectorAll(".row-check");
                    elems.forEach(function (elem) { elem.checked = false; });
                }

                // this.$.dataTable.render();
            },

            _dataChanged: function (newData, oldData) {
                var self = this;

                self.tableData = self.data;

                if (self.showColumns.length == 0) {
                    self.set("showColumns", Object.keys(self.tableData[0]));
                }

                var attributes = self._buildAttributes(self.tableData, self.showColumns);
                self._attributes = attributes;
            },

            _buildAttributes: function (data, columns) {

                var self = this;
                var attributes = [];
                var parsedData = {};

                self.filters["numFilters"] = 0;

                data.forEach(function (d) { d.checked = false; });

                columns.forEach(function (key) {
                    parsedData[key] = data.map(function (x) { return x[key]; });
                    var isNum = !parsedData[key].some(isNaN);
                    self.filters[key] = [];

                    if (isNum) {
                        attributes.push({
                            "name": key,
                            "type": "number",
                            "values": [parsedData[key].reduce(function (a, b) { return Math.max(a, b); }),
                            parsedData[key].reduce(function (a, b) { return Math.min(a, b); })]
                        });
                    }
                    else {
                        var isBoolean = !parsedData[key].some(isNaN);

                        if (isBoolean) {
                            attributes.push({
                                "name": key,
                                "type": "boolean",
                                "values": [true, false]
                            });
                        }
                        else {
                            attributes.push({
                                "name": key,
                                "type": "category",
                                "values": parsedData[key].filter(function (x, i, a) { return a.indexOf(x) == i; })
                            });
                        }
                    }
                });
                return attributes;
            },
            
            _sortAlphaNum : function(a,b) {
                var reA = /[^a-zA-Z]/g;
                var reN = /[^0-9]/g;
                var aA = String(a).replace(reA, "");
                var bA = String(b).replace(reA, "");
                if(aA === bA) {
                    var aN = parseInt(String(a).replace(reN, ""), 10);
                    var bN = parseInt(String(b).replace(reN, ""), 10);
                    return aN === bN ? 0 : aN > bN ? 1 : -1;
                } else {
                    return aA > bA ? 1 : -1;
                }
            }


            // created: function() {},
            // ready: function() {},
            // attached: function() {}

        });
    </script>
</dom-module>